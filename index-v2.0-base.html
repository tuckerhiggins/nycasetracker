<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; block-all-mixed-content;">
  <title>NYC Case Tracker</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="app-container">
    <h1>NYC Case Tracker</h1>

    <!-- Dashboard header -->
    <div class="dashboard-header">
      <div id="todayCard" class="today-card">
        <div class="today-title">Today</div>
        <div id="todayNcdCount" class="today-metric">0 court dates</div>
        <div id="todayDetails" class="today-sub">No court dates or to-dos due today.</div>
      </div>
      <div id="weekSummary" class="week-line">
        This week: no court dates or to-dos scheduled.
      </div>
    </div>

    <!-- Local backups + Quick 30.30 calculator -->
    <div class="backup-bar">
      <!-- Local encrypted backups -->
      <div class="backup-section">
        <div class="backup-section-title">Local backups</div>
        <div class="field">
          <label for="backupPassword">Backup password (for encrypted export/import)</label>
          <input id="backupPassword" type="password" placeholder="Set a password you'll remember">
          <div class="small-text">
            Used to encrypt/decrypt backups you move between computers.
            <strong>Backup before clearing site data, browsing history, cookies, etc. Otherwise, all Case Tracker data may be lost.</strong>
          </div>
        </div>
        <div class="backup-buttons">
          <button id="exportBtn" class="secondary">Export Encrypted Backup</button>
          <button id="importBtn" class="secondary">Import Encrypted Backup (replace)</button>
          <button id="importMergeBtn" class="secondary">Import & Merge Encrypted Backup</button>
          <button id="exportCalendarBtn" class="secondary">Export Court Dates to Calendar</button>
          <button id="clearCasesBtn" class="danger">Clear all cases on this device</button>
          <input id="importFile" type="file" accept=".txt,.json" style="display:none;">
          <input id="importMergeFile" type="file" accept=".txt,.json" style="display:none;">
        </div>
        <div class="small-text" id="backupStatus"></div>
      </div>

      <!-- Quick 30.30 calculator -->
      <div class="backup-section">
        <div class="backup-section-title">Quick 30.30 calculator</div>
        <div class="field">
          <label for="quickChargeLevel">Top Charge Level</label>
          <select id="quickChargeLevel">
            <option value="">Select...</option>
            <option value="felony">Felony (6 mo cap)</option>
            <option value="classA">Class A Misd (90 days)</option>
            <option value="classB">Class B Misd (60 days)</option>
            <option value="violation">Violation (30 days)</option>
          </select>
        </div>
        <div class="field">
          <label for="quickStartDate">Clock Start Date</label>
          <input id="quickStartDate" type="date">
        </div>

        <div class="modal-section-title">Excludable windows</div>
        <p class="small-text">
          Add any excludable periods. Days are counted as calendar days, inclusive of start and end.
        </p>
        <div id="quickExRows"></div>
        <button type="button" class="secondary small-link" id="quickExAddBtn" style="margin-top:0.3rem;">
          + Add window
        </button>
        <div class="small-text" style="margin-top:0.5rem;">
          Total excludable days: <span id="quickExTotal">0</span>
        </div>
        <div class="small-text" style="margin-top:0.25rem;">
          30.30 deadline: <span id="quickDeadline" title="" style="font-weight:600;"></span>
        </div>
      </div>
    </div>

    <!-- Security note -->
    <div class="small-text" style="margin-bottom:1rem;">
      Data is stored only in this browser's local storage on this device and is not synced to any server.
      Do <strong>not</strong> use this tool on shared or public computers. Use the encrypted backup options
      if you need to move or preserve your data.
    </div>

    <div class="top-bar">
      <form id="case-form">
        <div class="form-row">
          <div class="field">
            <label for="clientName">Client / Case Name</label>
            <input id="clientName" required placeholder="e.g., Doe, John">
          </div>
          <div class="field">
            <label for="docketNumber">Docket / Indictment #</label>
            <input id="docketNumber" placeholder="e.g., 2025NY123456">
          </div>
          <div class="field">
            <label for="chargeLevel">Top Charge Level</label>
            <select id="chargeLevel" required>
              <option value="">Select...</option>
              <option value="felony">Felony (6 mo cap)</option>
              <option value="classA">Class A Misd (90 days)</option>
              <option value="classB">Class B Misd (60 days)</option>
              <option value="violation">Violation (30 days)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="startDate">Clock Start Date</label>
            <input id="startDate" type="date" required>
            <div class="small-text" style="color:#6b7280;margin-top:0.25rem;">
              Typically the day the accusatory instrument was filed (CPL § 1.20[17]).
            </div>
          </div>
          <div class="field">
            <label for="ncd">Next Court Date (NCD)</label>
            <input id="ncd" type="date">
          </div>
          <div class="field">
            <label for="appearanceType">Next appearance is on for</label>
            <input id="appearanceType" list="appearanceTypes" placeholder="e.g., Supporting Depositions">
            <datalist id="appearanceTypes">
              <option value="Arraignment">
              <option value="Supporting Depositions">
              <option value="Motion (Defense)">
              <option value="Motion (People)">
              <option value="Conference">
              <option value="Hearings & Trial">
              <option value="Suppression Hearing">
              <option value="Plea">
              <option value="Sentence">
              <option value="Compliance">
            </datalist>
          </div>
          <div class="field">
            <label for="part">Part</label>
            <input id="part" placeholder="e.g., AP3, Part 41">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="excludedDays">Excluded Days (simple total)</label>
            <input id="excludedDays" type="number" min="0" value="0">
            <div class="small-text">
              For quick use, just put the total excludable days here. Advanced windows will auto-fill this.
            </div>
            <button type="button" class="secondary small-link" id="advancedMainToggle" style="margin-top:0.4rem;">
              Advanced excludable…
            </button>
          </div>

          <div class="field" id="advancedMainContainer" style="display:none;">
            <input id="definitelyExcludedDays" type="hidden" value="0">
            <input id="arguablyExcludedDays" type="hidden" value="0">
          </div>

          <div class="field" style="align-self:flex-end;">
            <label>
              <input type="checkbox" id="clockStopped">
              Clock is currently stopped
            </label>
            <div class="small-text">
              When checked, total days are frozen as of today.
            </div>
            <button type="submit" class="primary" style="margin-top:0.5rem;">Add / Update Case</button>
          </div>
        </div>

        <input type="hidden" id="editingId" value="">
      </form>

      <div class="field search-input">
        <label for="search">Filter Cases</label>
        <input id="search" placeholder="Search by client, docket, ADA, notes, phone, email...">
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-row">
      <div class="field-inline">
        <label for="sortMode">Sort by</label>
        <select id="sortMode">
          <option value="client">Client (A → Z)</option>
          <option value="ncd">Court date (soonest first)</option>
        </select>
      </div>

      <div class="field-inline">
        <label>View</label>
        <div class="view-modes">
          <button type="button" class="view-mode active" data-mode="all">All cases</button>
          <button type="button" class="view-mode" data-mode="today">Today</button>
          <button type="button" class="view-mode" data-mode="busy">Busy days</button>
          <button type="button" class="view-mode" data-mode="todos">To-dos</button>
        </div>
      </div>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="showWarrant">
          Include warrant cases
        </label>
        <label>
          <input type="checkbox" id="showClosed">
          Include closed cases
        </label>
        <label>
          <input type="checkbox" id="showReadyOnly">
          Ready cases only (COC filed)
        </label>
      </div>

      <button type="button" class="secondary small-link" id="advancedFiltersToggle">
        Advanced filters…
      </button>
    </div>

    <!-- Advanced filter panel -->
    <div id="advancedFilters" class="advanced-filters">
      <div class="field-inline">
        <label for="excludeMode">Excluded time mode</label>
        <select id="excludeMode">
          <option value="defOnly">Definitely excludable only</option>
          <option value="defPlusArg">Definitely + arguably excludable</option>
        </select>
      </div>

      <div id="busyThresholds" class="field-inline">
        <label for="minCasesBusy">Busy day: more than this many cases</label>
        <input id="minCasesBusy" type="number" min="1" value="3">
        <label for="minPartsBusy" style="margin-top:0.4rem;">…in more than this many parts</label>
        <input id="minPartsBusy" type="number" min="1" value="2">
      </div>
    </div>

    <!-- Busy day summary -->
    <div id="busySummary" class="small-text" style="margin-top:0.25rem;margin-bottom:0.25rem;">
    </div>

    <table>
      <thead>
        <tr>
          <th>Client</th>
          <th>Charge</th>
          <th>Start</th>
          <th>Total Days</th>
          <th>Excluded</th>
          <th>Chargeable</th>
          <th>Cap (days)</th>
          <th>Deadline</th>
          <th>NCD</th>
          <th>Part</th>
        </tr>
      </thead>
      <tbody id="casesBody">
      </tbody>
    </table>
  </div>

  <!-- Case details modal -->
  <div id="caseModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-body">
        <!-- Hero section (NEW) -->
        <div class="modal-hero">
          <h2 id="modalTitle">Case Details</h2>
          <div class="modal-key-info">
            <div class="info-card deadline-card">
              <div class="info-label">30.30 Deadline</div>
              <div class="info-value" id="modalHero3030">Calculating...</div>
              <div class="info-subtext">Chargeable vs cap days</div>
            </div>
            <div class="info-card court-card">
              <div class="info-label">Next Court Date</div>
              <div class="info-value" id="modalHeroNCD">Not set</div>
              <div class="info-subtext" id="modalHeroAppearance">On for: TBD</div>
            </div>
          </div>
        </div>

        <button class="modal-close" onclick="closeCaseModal()" style="position:absolute;top:1rem;right:1rem;">×</button>

        <div class="form-row">
          <div class="field">
            <label for="modalClientName">Client / Case Name</label>
            <input id="modalClientName">
          </div>
          <div class="field">
            <label for="modalDocketNumber">Docket / Indictment #</label>
            <input id="modalDocketNumber">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="modalClientPhone">Client phone</label>
            <input id="modalClientPhone" type="tel" placeholder="(555) 123-4567">
          </div>
          <div class="field">
            <label for="modalClientEmail">Client email</label>
            <input id="modalClientEmail" type="email" placeholder="client@example.com">
          </div>
        </div>

        <!-- To-do creation + list -->
        <div class="form-row" style="margin-bottom:0.5rem;">
          <button type="button" class="todo-cta small-link" id="modalTodoCreateBtn">
            + Create to-do for this case
          </button>
        </div>
        <div id="modalTodoCreateRow" style="display:none; margin-bottom:0.75rem;">
          <div class="form-row">
            <div class="field">
              <label for="modalTodoDescription">To-do description</label>
              <input id="modalTodoDescription" placeholder="e.g., Draft suppression motion">
            </div>
            <div class="field">
              <label for="modalTodoDeadline">Deadline</label>
              <input id="modalTodoDeadline" type="date">
            </div>
          </div>
          <button type="button" class="primary small-link" onclick="addTodoToCurrentCase()">
            Add to-do
          </button>
        </div>
        <div class="modal-section-title">To-dos</div>
        <ul id="modalTodoList" class="notes-list"></ul>

        <!-- Charges section (NEW) -->
        <div class="modal-section-title" style="margin-top:1rem;">Charges</div>
        <div id="chargesList" class="charges-list"></div>
        <button type="button" class="secondary small-link" id="addChargeBtn" style="margin-top:0.5rem;">
          + Add Charge
        </button>

        <div id="chargeInputRow" style="display:none; margin-top:0.5rem;">
          <div class="form-row">
            <div class="field">
              <label>Charge Name</label>
              <input id="newChargeName" placeholder="e.g., Robbery in the Second Degree">
            </div>
            <div class="field">
              <label>Statute</label>
              <input id="newChargeStatute" placeholder="e.g., PL § 160.10(1)">
            </div>
            <div class="field">
              <label>Class</label>
              <select id="newChargeClass">
                <option value="felony">Felony</option>
                <option value="classA">Class A Misd</option>
                <option value="classB">Class B Misd</option>
                <option value="violation">Violation</option>
              </select>
            </div>
          </div>
          <label style="font-size:0.85rem;">
            <input type="checkbox" id="newChargePrimary">
            Primary/Top Charge (determines 30.30 cap)
          </label>
          <div style="margin-top:0.5rem;">
            <button class="primary small-link" onclick="saveNewCharge()">Add</button>
            <button class="secondary small-link" onclick="cancelNewCharge()">Cancel</button>
          </div>
        </div>

        <div class="form-row" style="margin-top:0.75rem;">
          <div class="field">
            <label for="modalChargeLevel">Top Charge Level</label>
            <select id="modalChargeLevel">
              <option value="">Select...</option>
              <option value="felony">Felony</option>
              <option value="classA">Class A Misd</option>
              <option value="classB">Class B Misd</option>
              <option value="violation">Violation</option>
            </select>
          </div>
          <div class="field">
            <label for="modalStartDate">Clock Start Date</label>
            <input id="modalStartDate" type="date">
            <div class="small-text" style="color:#6b7280;margin-top:0.25rem;">
              Typically the day the accusatory instrument was filed (CPL § 1.20[17]).
            </div>
          </div>
          <div class="field">
            <label for="modalArraignmentDate">Arraignment Date (optional)</label>
            <input id="modalArraignmentDate" type="date">
          </div>
          <div class="field">
            <label for="modalExcludedDays">Excluded Days (simple)</label>
            <input id="modalExcludedDays" type="number" min="0">
          </div>
        </div>

        <!-- Always-visible 30.30 date -->
        <div class="modal-section-title" style="margin-top:0.75rem;">30.30 Date (this case)</div>
        <div class="small-text">
          30.30 Date: <span id="modal3030Date"></span>
        </div>

        <div class="form-row">
          <button type="button" class="secondary small-link" id="advancedModalToggle">
            Advanced excludable…
          </button>
        </div>

        <!-- Advanced excludable section in modal -->
        <div id="advancedModalContainer" style="display:none; flex-direction:column; gap:0.75rem;">
          <div class="form-row">
            <div class="field">
              <label for="modalDefExcluded">Definitely excludable days</label>
              <input id="modalDefExcluded" type="number" min="0" readonly>
            </div>
            <div class="field">
              <label for="modalArgExcluded">Arguably excludable days</label>
              <input id="modalArgExcluded" type="number" min="0" readonly>
            </div>
          </div>

          <div class="modal-section-title">Excludable calculator (this case)</div>
          <p class="small-text">
            Add windows of excludable time with reasons. Windows marked "Arg. excludable" will
            be counted as arguably excludable; others count as definitely excludable. Simple excluded
            days = definitely + arguably.
          </p>
          <div id="modalExRows"></div>
          <button type="button" class="secondary small-link" id="modalExAddBtn" style="margin-top:0.3rem;">
            + Add window
          </button>
          <div class="small-text" style="margin-top:0.5rem;">
            Definitely excludable from windows: <span id="modalExDefTotal">0</span>
          </div>
          <div class="small-text">
            Arguably excludable from windows: <span id="modalExArgTotal">0</span>
          </div>
          <div class="small-text">
            Total excludable (simple): <span id="modalExTotal">0</span>
          </div>

          <div class="small-text" style="margin-top:0.75rem;">
            <label>
              <input type="checkbox" id="modalIncludeArg" checked>
              Include arguably excludable days in 30.30 Date
            </label>
          </div>
        </div>

        <div class="form-row" style="margin-top:1rem;">
          <div class="field">
            <label for="modalNcd">Next Court Date (NCD)</label>
            <input id="modalNcd" type="date">
          </div>
          <div class="field">
            <label for="modalAppearanceType">Next appearance is on for</label>
            <input id="modalAppearanceType" list="appearanceTypes" placeholder="e.g., Supporting Depositions">
          </div>
          <div class="field">
            <label for="modalPart">Part</label>
            <input id="modalPart" placeholder="e.g., AP3, Part 41">
          </div>
          <div class="field">
            <label for="modalAda">Assigned ADA</label>
            <input id="modalAda" placeholder="ADA Name">
          </div>
        </div>

        <div class="checkbox-inline">
          <label>
            <input type="checkbox" id="modalClockStopped">
            Clock currently stopped
          </label>
          <label>
            <input type="checkbox" id="modalWarrant">
            Warrant
          </label>
          <label>
            <input type="checkbox" id="modalClosed">
            Closed
          </label>
        </div>

        <div class="form-row" style="margin-top:0.75rem;">
          <div class="field">
            <label>
              <input type="checkbox" id="modalCocFiled">
              COC filed
            </label>
            <div class="small-text">
              When a COC is filed, the clock stops as of that date.
            </div>
          </div>
          <div class="field">
            <label for="modalCocDate">COC date</label>
            <input id="modalCocDate" type="date">
          </div>
        </div>

        <div>
          <div class="modal-section-title">Notes</div>
          <ul id="modalNotesList" class="notes-list"></ul>
          <div class="form-row">
            <div class="field">
              <label for="modalNoteDate">Note Date</label>
              <input id="modalNoteDate" type="date">
            </div>
            <div class="field">
              <label for="modalNoteText">Note Text</label>
              <textarea id="modalNoteText" rows="2" placeholder="e.g., People served discovery; defense asked for adjournment..."></textarea>
            </div>
          </div>
          <button class="secondary" onclick="addNoteToCurrentCase()">Add Note</button>
        </div>

        <div style="margin-top: 1rem; display:flex; justify-content: space-between; gap:0.5rem; flex-wrap:wrap;">
          <button class="secondary" type="button" onclick="exportCurrentCase()">Export this case</button>
          <button class="primary" type="button" onclick="saveModalChanges()">Save changes</button>
          <button class="danger" type="button" onclick="deleteCurrentCase()">Delete case</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced excludable modal for main form -->
  <div id="advExModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>Advanced excludable time</h2>
        <button class="modal-close" onclick="closeAdvExModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-section-title">Excludable calculator (new case)</div>
        <p class="small-text">
          Add one or more windows of excludable time with reasons. Windows marked "Arg. excludable"
          are treated as arguably excludable; others are definitely excludable. Simple excluded days
          on the main form will always equal definitely + arguably.
        </p>

        <div id="exCalcRows"></div>

        <button type="button" class="secondary small-link" id="exCalcAddBtn" style="margin-top:0.3rem;">
          + Add window
        </button>

        <div class="small-text" style="margin-top:0.5rem;">
          Definitely excludable from windows: <span id="exCalcDefTotal">0</span>
        </div>
        <div class="small-text">
          Arguably excludable from windows: <span id="exCalcArgTotal">0</span>
        </div>
        <div class="small-text">
          Total excludable (simple): <span id="exCalcTotal">0</span>
        </div>

        <div style="margin-top: 1rem; display:flex; justify-content: flex-end; gap:0.5rem;">
          <button class="primary" type="button" onclick="saveAdvExAndClose()">Done</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>
      Data entered here is stored only in your browser on this device and is never transmitted to a server.
      Use the encrypted backup feature if you need to move or preserve data between devices.
    </p>
    <p>
      This tool is provided for internal reference and organizational purposes only. Attorneys are solely
      responsible for verifying and calculating all chargeable and excludable time under CPL § 30.30 or
      other applicable rules. No guarantee of accuracy is provided.
    </p>
  </footer>

  <script type="module" src="js/app.js"></script>
</body>
</html>
