<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; block-all-mixed-content;">
  <title>NYC Case Tracker v2.1</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="app-container">
    <h1>NYC Case Tracker v2.1</h1>

    <!-- Dashboard header -->
    <div class="dashboard-header">
      <div id="todayCard" class="today-card">
        <div class="today-title">Today</div>
        <div id="todayNcdCount" class="today-metric">0 court dates</div>
        <div id="todayDetails" class="today-sub">No court dates or to-dos due today.</div>
      </div>
      <div id="weekSummary" class="week-line">
        This week: no court dates or to-dos scheduled.
      </div>
    </div>

    <!-- Quick Actions Bar (v2.1) -->
    <div class="quick-actions-bar">
      <button id="emailTodayBtn" class="action-btn action-today-small">üìß Email Today's Cases</button>
      <button id="printTodayBtn" class="action-btn action-today-small">üñ®Ô∏è Print Today's Cases</button>
      <button id="exportCalendarBtn" class="action-btn action-secondary-small">üìÖ Export Court Dates</button>
    </div>

    <!-- Local backups + Quick 30.30 calculator -->
    <div class="backup-bar">
      <!-- Local encrypted backups -->
      <div class="backup-section">
        <div class="backup-section-title">Local backups</div>
        <div class="field">
          <label for="backupPassword">Backup password (for encrypted export/import)</label>
          <input id="backupPassword" type="password" placeholder="Set a password you'll remember">
          <div class="small-text">
            Used to encrypt/decrypt backups you move between computers.
            <strong>Backup before clearing site data, browsing history, cookies, etc. Otherwise, all Case Tracker data may be lost.</strong>
          </div>
        </div>
        <div class="backup-buttons">
          <button id="exportBtn" class="secondary">Export Encrypted Backup</button>
          <button id="importBtn" class="secondary">Import Encrypted Backup</button>
          <button id="importMergeBtn" class="secondary">Import & Merge</button>
          <button id="clearCasesBtn" class="danger">‚ö†Ô∏è Clear All Cases</button>
          <input id="importFile" type="file" accept=".txt,.json" style="display:none;">
        </div>
        <div class="small-text" id="backupStatus"></div>
      </div>

      <!-- Quick 30.30 calculator -->
      <div class="backup-section">
        <div class="backup-section-title">Quick 30.30 calculator</div>
        <div class="field">
          <label for="quickChargeLevel">Top Charge Level</label>
          <select id="quickChargeLevel">
            <option value="">Select...</option>
            <option value="felony">Felony (6 mo cap)</option>
            <option value="classA">Class A Misd (90 days)</option>
            <option value="classB">Class B Misd (60 days)</option>
            <option value="violation">Violation (30 days)</option>
          </select>
        </div>
        <div class="field">
          <label for="quickStartDate">Clock Start Date</label>
          <input id="quickStartDate" type="date">
        </div>

        <div class="modal-section-title">Excludable windows</div>
        <p class="small-text">
          Add any excludable periods. Days are counted as calendar days, inclusive of start and end.
        </p>
        <div id="quickExRows"></div>
        <button type="button" class="secondary small-link" id="quickExAddBtn" style="margin-top:0.3rem;">
          + Add window
        </button>
        <div class="small-text" style="margin-top:0.5rem;">
          Total excludable days: <span id="quickExTotal">0</span>
        </div>
        <div class="small-text" style="margin-top:0.25rem;">
          30.30 deadline: <span id="quickDeadline" title="" style="font-weight:600;"></span>
        </div>
      </div>
    </div>

    <!-- Security note -->
    <div class="small-text" style="margin-bottom:1rem;">
      Data is stored only in this browser's local storage on this device and is not synced to any server.
      Do <strong>not</strong> use this tool on shared or public computers. Use the encrypted backup options
      if you need to move or preserve your data.
    </div>

    <div class="top-bar">
      <form id="case-form">
        <div class="form-row">
          <div class="field">
            <label for="clientName">Client / Case Name</label>
            <input id="clientName" required placeholder="e.g., Doe, John">
          </div>
          <div class="field">
            <label for="docketNumber">Docket / Indictment #</label>
            <input id="docketNumber" placeholder="e.g., 2025NY123456">
          </div>
          <div class="field">
            <label for="chargeLevel">Top Charge Level</label>
            <select id="chargeLevel" required>
              <option value="">Select...</option>
              <option value="felony">Felony (6 mo cap)</option>
              <option value="classA">Class A Misd (90 days)</option>
              <option value="classB">Class B Misd (60 days)</option>
              <option value="violation">Violation (30 days)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="startDate">Clock Start Date</label>
            <input id="startDate" type="date" required>
            <div class="small-text" style="color:#6b7280;margin-top:0.25rem;">
              Typically the day the accusatory instrument was filed (CPL ¬ß 1.20[17]).
            </div>
          </div>
          <div class="field">
            <label for="ncd">Next Court Date (NCD)</label>
            <input id="ncd" type="date">
          </div>
          <div class="field">
            <label for="appearanceType">Next appearance is on for</label>
            <input id="appearanceType" list="appearanceTypes" placeholder="e.g., Supporting Depositions">
            <datalist id="appearanceTypes">
              <option value="Arraignment">
              <option value="Supporting Depositions">
              <option value="Motion (Defense)">
              <option value="Motion (People)">
              <option value="Conference">
              <option value="Hearings & Trial">
              <option value="Suppression Hearing">
              <option value="Plea">
              <option value="Sentence">
              <option value="Compliance">
            </datalist>
          </div>
          <div class="field">
            <label for="part">Part</label>
            <input id="part" placeholder="e.g., AP3, Part 41">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="excludedDays">Excluded Days (simple total)</label>
            <input id="excludedDays" type="number" min="0" value="0">
            <div class="small-text">
              For quick use, just put the total excludable days here. Advanced windows will auto-fill this.
            </div>
          </div>

          <div class="field" id="advancedMainContainer" style="display:none;">
            <input id="definitelyExcludedDays" type="hidden" value="0">
            <input id="arguablyExcludedDays" type="hidden" value="0">
          </div>
        </div>

        <div class="form-row" style="align-items: center;">
          <div class="field">
            <label>
              <input type="checkbox" id="clockStopped">
              Clock is currently stopped
            </label>
            <div class="small-text">
              When checked, total days are frozen as of today.
            </div>
          </div>

          <div class="field">
            <button type="button" class="secondary small-link" id="advancedMainToggle">
              ‚öôÔ∏è Advanced excludable time
            </button>
          </div>

          <div class="field" style="display: flex; justify-content: flex-end;">
            <button type="submit" class="primary">Quick Add Case</button>
          </div>
        </div>

        <input type="hidden" id="editingId" value="">
      </form>

      <div class="field search-input">
        <label for="search">Filter Cases</label>
        <input id="search" placeholder="Search by client, docket, ADA, notes, phone, email...">
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-row">
      <div class="field-inline">
        <label for="sortMode">Sort by</label>
        <select id="sortMode">
          <option value="client">Client (A ‚Üí Z)</option>
          <option value="ncd">Court date (soonest first)</option>
        </select>
      </div>

      <div class="field-inline">
        <label>View</label>
        <div class="view-modes">
          <button type="button" class="view-mode active" data-mode="all">All cases</button>
          <button type="button" class="view-mode" data-mode="today">Today</button>
          <button type="button" class="view-mode" data-mode="busy">Busy days</button>
          <button type="button" class="view-mode" data-mode="todos">To-dos</button>
        </div>
      </div>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="showWarrant">
          Include warrant cases
        </label>
        <label>
          <input type="checkbox" id="showClosed">
          Include closed cases
        </label>
        <label>
          <input type="checkbox" id="showReadyOnly">
          Ready cases only (COC filed)
        </label>
      </div>

      <button type="button" class="secondary small-link" id="advancedFiltersToggle">
        Advanced filters‚Ä¶
      </button>
    </div>

    <!-- Advanced filter panel -->
    <div id="advancedFilters" class="advanced-filters">
      <div class="field-inline">
        <label for="excludeMode">Excluded time mode</label>
        <select id="excludeMode">
          <option value="defOnly">Definitely excludable only</option>
          <option value="defPlusArg">Definitely + arguably excludable</option>
        </select>
      </div>

      <div id="busyThresholds" class="field-inline">
        <label for="minCasesBusy">Busy day: more than this many cases</label>
        <input id="minCasesBusy" type="number" min="1" value="3">
        <label for="minPartsBusy" style="margin-top:0.4rem;">‚Ä¶in more than this many parts</label>
        <input id="minPartsBusy" type="number" min="1" value="2">
      </div>
    </div>

    <!-- Busy day summary -->
    <div id="busySummary" class="small-text" style="margin-top:0.25rem;margin-bottom:0.25rem;">
    </div>

    <table>
      <thead>
        <tr>
          <th>Client</th>
          <th>Charge</th>
          <th>Start</th>
          <th>Total Days</th>
          <th>Excluded</th>
          <th>Chargeable</th>
          <th>Cap (days)</th>
          <th>Deadline</th>
          <th>NCD</th>
          <th>Part</th>
        </tr>
      </thead>
      <tbody id="casesBody">
      </tbody>
    </table>

    <!-- Mobile card view (v2.1) -->
    <div id="mobileCardsContainer" class="mobile-cards">
    </div>
  </div>

  <!-- Case details modal - IMPROVED UX -->
  <div id="caseModal" class="modal-overlay">
    <div class="modal modal-enhanced">
      <div class="modal-body">
        <!-- HEADER: Hero section with key metrics -->
        <div class="modal-hero">
          <div class="hero-left">
            <h2 id="modalTitle">Case Details</h2>
            <div class="hero-quick-actions">
              <button class="action-link" id="quickEmailCase" title="Email case details">üìß</button>
              <button class="action-link" id="quickPrintCase" title="Print case">üñ®Ô∏è</button>
              <button class="action-link" id="quickCopyDocket" title="Copy docket">üìã</button>
            </div>
          </div>
          <div class="modal-key-info">
            <div class="info-card deadline-card">
              <div class="info-label">30.30 Deadline</div>
              <div class="info-value" id="modalHero3030">Calculating...</div>
              <div class="info-subtext">Chargeable vs cap days</div>
            </div>
            <div class="info-card court-card">
              <div class="info-label">Next Court Date</div>
              <div class="info-value" id="modalHeroNCD">Not set</div>
              <div class="info-subtext" id="modalHeroAppearance">On for: TBD</div>
            </div>
          </div>
        </div>

        <button class="modal-close" id="closeCaseModalBtn">√ó</button>

        <!-- SECTION 1: üë§ WHO (Identity & Contact) -->
        <section class="modal-section section-who">
          <h3 class="section-header">üë§ WHO - Identity & Contact</h3>
          
          <div class="form-row">
            <div class="field">
              <label for="modalClientName">Client / Case Name</label>
              <input id="modalClientName" class="input-emphasized">
            </div>
            <div class="field">
              <label for="modalDocketNumber">Docket / Indictment #</label>
              <input id="modalDocketNumber">
            </div>
          </div>

          <!-- Primary Contact -->
          <div class="form-row">
            <div class="field">
              <label for="modalClientPhone">Primary Phone</label>
              <input id="modalClientPhone" type="tel" placeholder="(555) 123-4567">
            </div>
            <div class="field">
              <label for="modalClientEmail">Primary Email</label>
              <input id="modalClientEmail" type="email" placeholder="client@example.com">
            </div>
          </div>

          <!-- Additional Contacts (Collapsible) -->
          <div class="contacts-additional">
            <button type="button" class="expand-toggle" id="expandContactsBtn">
              <span id="contactsToggleIcon">‚ñ∂</span> Additional contacts
              <span class="contact-count" id="additionalContactCount"></span>
            </button>
            
            <div id="additionalContactsSection" class="additional-contacts-content" style="display:none;">
              <!-- Phones -->
              <div class="contact-subsection">
                <div class="subsection-header-small">
                  <span>üìû Phone Numbers</span>
                  <button type="button" class="add-link" id="addPhoneBtn">+ Add</button>
                </div>
                <div id="phonesList" class="contact-items-list"></div>
              </div>

              <!-- Emails -->
              <div class="contact-subsection">
                <div class="subsection-header-small">
                  <span>üìß Email Addresses</span>
                  <button type="button" class="add-link" id="addEmailBtn">+ Add</button>
                </div>
                <div id="emailsList" class="contact-items-list"></div>
              </div>

              <!-- Address -->
              <div class="field" style="margin-top:0.75rem;">
                <label for="modalAddress">Physical Address</label>
                <textarea id="modalAddress" rows="2" placeholder="Street, apartment, city, state, zip"></textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION 2: ‚öñÔ∏è WHAT (The Charges) -->
        <section class="modal-section section-charges">
          <h3 class="section-header">‚öñÔ∏è WHAT - Charges</h3>
          
          <div id="chargesList" class="charges-visual-list"></div>
          <button type="button" class="add-charge-btn" id="addChargeBtn">
            + Add Charge
          </button>

          <div id="chargeInputRow" class="charge-input-form" style="display:none;">
            <div class="form-row">
              <div class="field">
                <label>Charge Name</label>
                <input id="newChargeName" placeholder="e.g., Assault 2nd Degree">
              </div>
              <div class="field">
                <label>Statute</label>
                <input id="newChargeStatute" placeholder="e.g., PL ¬ß 120.05">
              </div>
              <div class="field">
                <label>Class</label>
                <select id="newChargeClass">
                  <option value="felony">Felony</option>
                  <option value="classA">Class A Misd</option>
                  <option value="classB">Class B Misd</option>
                  <option value="violation">Violation</option>
                </select>
              </div>
            </div>
            <label class="checkbox-label">
              <input type="checkbox" id="newChargePrimary">
              <span>‚≠ê Primary/Top Charge (determines 30.30 cap)</span>
            </label>
            <div class="form-actions">
              <button class="primary small-link" id="saveChargeBtn">Add Charge</button>
              <button class="secondary small-link" id="cancelChargeBtn">Cancel</button>
            </div>
          </div>

          <div class="form-row" style="margin-top:1rem;">
            <div class="field">
              <label for="modalChargeLevel">Top Charge Level (for 30.30 cap)</label>
              <select id="modalChargeLevel">
                <option value="">Select...</option>
                <option value="felony">Felony (6 mo)</option>
                <option value="classA">Class A Misd (90 days)</option>
                <option value="classB">Class B Misd (60 days)</option>
                <option value="violation">Violation (30 days)</option>
              </select>
            </div>
          </div>
        </section>

        <!-- SECTION 3: üìÖ WHEN (Dates & Deadlines) -->
        <section class="modal-section section-dates">
          <h3 class="section-header">üìÖ WHEN - Dates & Deadlines</h3>
          
          <div class="form-row">
            <div class="field">
              <label for="modalStartDate">Clock Start Date</label>
              <input id="modalStartDate" type="date">
              <div class="field-help">Typically when accusatory instrument was filed (CPL ¬ß 1.20[17])</div>
            </div>
            <div class="field">
              <label for="modalArraignmentDate">Arraignment Date</label>
              <input id="modalArraignmentDate" type="date">
            </div>
          </div>

          <!-- Court Date Info -->
          <div class="court-date-group">
            <label class="group-label">Next Court Appearance</label>
            <div class="form-row-tight">
              <div class="field">
                <input id="modalNcd" type="date" placeholder="Date">
              </div>
              <div class="field">
                <input id="modalAppearanceType" list="appearanceTypes" placeholder="On for...">
              </div>
              <div class="field">
                <input id="modalPart" placeholder="Part">
              </div>
              <div class="field">
                <input id="modalAda" placeholder="ADA">
              </div>
            </div>
          </div>

          <!-- 30.30 Calculation -->
          <div class="deadline-calculation">
            <div class="calc-display">
              <span class="calc-label">30.30 Deadline:</span>
              <span id="modal3030Date" class="calc-value">Calculating...</span>
            </div>
            <div class="form-row" style="margin-top:0.5rem;">
              <div class="field">
                <label for="modalExcludedDays">Excluded Days (simple total)</label>
                <input id="modalExcludedDays" type="number" min="0">
              </div>
              <div class="field" style="align-self:flex-end;">
                <button type="button" class="secondary small-link" id="advancedModalToggle">
                  ‚öôÔ∏è Advanced excludable time...
                </button>
              </div>
            </div>
          </div>

          <!-- Advanced Excludable (Collapsible) -->
          <div id="advancedModalContainer" class="advanced-modal-section" style="display:none;">
            <div class="form-row">
              <div class="field">
                <label for="modalDefExcluded">Definitely excludable</label>
                <input id="modalDefExcluded" type="number" min="0" readonly>
              </div>
              <div class="field">
                <label for="modalArgExcluded">Arguably excludable</label>
                <input id="modalArgExcluded" type="number" min="0" readonly>
              </div>
            </div>

            <p class="field-help">
              Add windows of excludable time with reasons. Mark "Arg. excludable" for disputed periods.
            </p>
            <div id="modalExRows"></div>
            <button type="button" class="secondary small-link" id="modalExAddBtn" style="margin-top:0.5rem;">
              + Add window
            </button>
            <div class="excludable-summary">
              <div>Definitely: <span id="modalExDefTotal">0</span> days</div>
              <div>Arguably: <span id="modalExArgTotal">0</span> days</div>
              <div>Total: <span id="modalExTotal">0</span> days</div>
            </div>

            <label class="checkbox-label" style="margin-top:0.5rem;">
              <input type="checkbox" id="modalIncludeArg" checked>
              <span>Include arguably excludable days in 30.30 date</span>
            </label>
          </div>
        </section>

        <!-- SECTION 4: üö® STATUS (What's Happening) -->
        <section class="modal-section section-status">
          <h3 class="section-header">üö® STATUS - Case Flags</h3>
          
          <div class="status-grid">
            <label class="status-badge status-warrant">
              <input type="checkbox" id="modalWarrant">
              <span class="status-icon">üî¥</span>
              <span class="status-text">Warrant</span>
            </label>
            <label class="status-badge status-stopped">
              <input type="checkbox" id="modalClockStopped">
              <span class="status-icon">üü°</span>
              <span class="status-text">Clock Stopped</span>
            </label>
            <label class="status-badge status-ready">
              <input type="checkbox" id="modalCocFiled">
              <span class="status-icon">üü¢</span>
              <span class="status-text">COC Filed (Ready)</span>
            </label>
            <label class="status-badge status-closed">
              <input type="checkbox" id="modalClosed">
              <span class="status-icon">‚ö´</span>
              <span class="status-text">Case Closed</span>
            </label>
          </div>

          <div class="form-row" style="margin-top:0.75rem;">
            <div class="field" id="warrantDateField" style="display:none;">
              <label for="modalWarrantDate">Warrant Issued Date</label>
              <input id="modalWarrantDate" type="date">
            </div>
            <div class="field" id="cocDateField" style="display:none;">
              <label for="modalCocDate">COC Filed Date</label>
              <input id="modalCocDate" type="date">
              <div class="field-help">Clock stops as of this date</div>
            </div>
          </div>
        </section>

        <!-- SECTION 5: üìù WORK (To-Dos & Notes) -->
        <section class="modal-section section-work">
          <h3 class="section-header">üìù WORK - To-Dos & Notes</h3>
          
          <!-- To-Dos -->
          <div class="work-subsection">
            <div class="subsection-header-small">
              <span>‚úì To-Dos</span>
              <button type="button" class="todo-cta small-link" id="modalTodoCreateBtn">
                + Create to-do
              </button>
            </div>

            <div id="modalTodoCreateRow" class="todo-create-form" style="display:none;">
              <div class="form-row">
                <div class="field" style="flex:2;">
                  <input id="modalTodoDescription" placeholder="What needs to be done?">
                </div>
                <div class="field">
                  <input id="modalTodoDeadline" type="date">
                </div>
                <button type="button" class="primary small-link" id="addTodoBtn">Add</button>
              </div>
            </div>

            <ul id="modalTodoList" class="todos-list"></ul>
          </div>

          <!-- Notes -->
          <div class="work-subsection">
            <div class="subsection-header-small">
              <span>üìÑ Case Notes</span>
            </div>
            
            <ul id="modalNotesList" class="notes-list"></ul>
            
            <div class="form-row" style="margin-top:0.75rem;">
              <div class="field">
                <input id="modalNoteDate" type="date">
              </div>
              <div class="field" style="flex:2;">
                <textarea id="modalNoteText" rows="2" placeholder="Add a note about this case..."></textarea>
              </div>
              <button class="secondary small-link" id="addNoteBtn">Add Note</button>
            </div>
          </div>
        </section>

        <!-- FOOTER: Actions -->
        <div class="modal-footer">
          <button class="secondary" type="button" id="exportCaseBtn">Export Case</button>
          <div class="footer-right">
            <button class="primary" type="button" id="saveChangesBtn">Save Changes</button>
            <button class="danger" type="button" id="deleteCaseBtn">Delete Case</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Advanced excludable modal for main form -->
  <div id="advExModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>Advanced excludable time</h2>
        <button class="modal-close" id="closeAdvExModalBtn">√ó</button>
      </div>
      <div class="modal-body">
        <div class="modal-section-title">Excludable calculator (new case)</div>
        <p class="small-text">
          Add one or more windows of excludable time with reasons. Windows marked "Arg. excludable"
          are treated as arguably excludable; others are definitely excludable. Simple excluded days
          on the main form will always equal definitely + arguably.
        </p>

        <div id="exCalcRows"></div>

        <button type="button" class="secondary small-link" id="exCalcAddBtn" style="margin-top:0.3rem;">
          + Add window
        </button>

        <div class="small-text" style="margin-top:0.5rem;">
          Definitely excludable from windows: <span id="exCalcDefTotal">0</span>
        </div>
        <div class="small-text">
          Arguably excludable from windows: <span id="exCalcArgTotal">0</span>
        </div>
        <div class="small-text">
          Total excludable (simple): <span id="exCalcTotal">0</span>
        </div>

        <div style="margin-top: 1rem; display:flex; justify-content: flex-end; gap:0.5rem;">
          <button class="primary" type="button" id="saveAdvExBtn">Done</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>
      Data entered here is stored only in your browser on this device and is never transmitted to a server.
      Use the encrypted backup feature if you need to move or preserve data between devices.
    </p>
    <p>
      This tool is provided for internal reference and organizational purposes only. Attorneys are solely
      responsible for verifying and calculating all chargeable and excludable time under CPL ¬ß 30.30 or
      other applicable rules. No guarantee of accuracy is provided.
    </p>
  </footer>

  <script type="module" src="js/app.js"></script>
</body>
</html>
