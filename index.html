<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Case Tracker</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f7;
    }
    h1 {
      margin-top: 0;
    }
    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .field {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 150px;
    }
    label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    input, select, textarea {
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    button {
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.danger {
      background: #ef4444;
      color: white;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .small-link {
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      border-radius: 999px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.85rem;
    }
    th, td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .tag {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .tag-felony { background: #fee2e2; color: #b91c1c; }
    .tag-a { background: #e0f2fe; color: #1d4ed8; }
    .tag-b { background: #dcfce7; color: #166534; }
    .tag-v { background: #fef3c7; color: #92400e; }
    .small-text {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .search-input {
      max-width: 260px;
    }

    .backup-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: stretch;
      margin-bottom: 1rem;
    }
    .backup-section {
      flex: 1;
      min-width: 260px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .backup-section-title {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
    }
    .backup-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }
    .filters-row .field-inline {
      display: flex;
      flex-direction: column;
      min-width: 160px;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      font-size: 0.8rem;
    }
    .checkbox-group label {
      font-weight: 400;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .ncd-red {
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 600;
    }
    .ncd-yellow {
      background: #fef9c3;
      color: #92400e;
      font-weight: 600;
    }
    .ncd-green {
      background: #dcfce7;
      color: #166534;
      font-weight: 600;
    }

    .row-warrant {
      background: #fef2f2;
    }
    .row-closed {
      opacity: 0.6;
    }
    .badge {
      display: inline-block;
      padding: 0.1rem 0.35rem;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-left: 0.25rem;
    }
    .badge-warrant {
      background: #fee2e2;
      color: #b91c1c;
    }
    .badge-closed {
      background: #e5e7eb;
      color: #374151;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }
    .modal-close {
      cursor: pointer;
      font-size: 1.2rem;
      border: none;
      background: transparent;
    }
    .modal-section-title {
      font-size: 0.85rem;
      font-weight: 700;
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
    }
    .notes-list {
      margin: 0;
      padding-left: 1rem;
      font-size: 0.8rem;
    }
    .notes-list li {
      margin-bottom: 0.25rem;
    }
    .note-date {
      font-weight: 600;
    }
    .checkbox-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    .excalc-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .excalc-row input[type="date"] {
      min-width: 140px;
      flex: 1;
    }
    .excalc-days {
      font-size: 0.8rem;
      color: #374151;
    }

    @media (max-width: 700px) {
      table {
        font-size: 0.75rem;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .modal {
        max-width: 95vw;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>Case Tracker</h1>

    <!-- Local backups + Cloud sync (beta) -->
    <div class="backup-bar">
      <!-- Local encrypted backups -->
      <div class="backup-section">
        <div class="backup-section-title">Local backups</div>
        <div class="field">
          <label for="backupPassword">Backup password (for encrypted export/import)</label>
          <input id="backupPassword" type="password" placeholder="Set a password you'll remember">
          <div class="small-text">
            Used only to encrypt/decrypt backups you move between computers.
          </div>
        </div>
        <div class="backup-buttons">
          <button id="exportBtn" class="secondary">Export Encrypted Backup</button>
          <button id="importBtn" class="secondary">Import Encrypted Backup</button>
          <input id="importFile" type="file" accept=".txt,.json" style="display:none;">
        </div>
        <div class="small-text" id="backupStatus"></div>
      </div>

      <!-- Cloud sync (beta) -->
      <div class="backup-section">
        <div class="backup-section-title">Cloud sync (beta)</div>
        <div id="cloudLoginForm">
          <div class="field">
            <label>Cloud login</label>
            <input id="cloudEmail" type="email" placeholder="email@example.com" style="margin-bottom:0.3rem;">
            <input id="cloudPassword" type="password" placeholder="Password" style="margin-bottom:0.4rem;">
            <div class="backup-buttons">
              <button id="cloudSignUp" class="secondary">Sign up</button>
              <button id="cloudSignIn" class="secondary">Sign in</button>
            </div>
          </div>
        </div>
        <div id="cloudSignedInRow" class="backup-buttons" style="display:none; margin-top:0.4rem;">
          <span class="small-text" id="cloudUserStatus"></span>
          <button id="cloudSignOut" class="secondary">Sign out</button>
        </div>
        <div class="backup-buttons" style="margin-top:0.4rem;">
          <button id="cloudSaveBtn" class="secondary">Save to Cloud</button>
        </div>
        <div class="small-text" id="cloudStatus"></div>
        <div class="small-text">
          Note: Client name and docket number will not be uploaded to the cloud.
        </div>
      </div>
    </div>

    <div class="top-bar">
      <form id="case-form">
        <div class="form-row">
          <div class="field">
            <label for="clientName">Client / Case Name</label>
            <input id="clientName" required placeholder="e.g., Doe, John">
          </div>
          <div class="field">
            <label for="docketNumber">Docket / Indictment #</label>
            <input id="docketNumber" placeholder="e.g., 2025NY123456">
          </div>
          <div class="field">
            <label for="chargeLevel">Top Charge Level</label>
            <select id="chargeLevel" required>
              <option value="">Select...</option>
              <option value="felony">Felony (6 mo cap)</option>
              <option value="classA">Class A Misd (90 days)</option>
              <option value="classB">Class B Misd (60 days)</option>
              <option value="violation">Violation (30 days)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="startDate">Clock Start Date</label>
            <input id="startDate" type="date" required>
          </div>
          <div class="field">
            <label for="ncd">Next Court Date (NCD)</label>
            <input id="ncd" type="date">
          </div>
          <div class="field">
            <label for="part">Part</label>
            <input id="part" placeholder="e.g., AP3, Part 41">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="excludedDays">Excluded Days (simple total)</label>
            <input id="excludedDays" type="number" min="0" value="0">
            <div class="small-text">
              For quick use, just put the total excludable days here.
            </div>
            <button type="button" class="secondary small-link" id="advancedMainToggle" style="margin-top:0.4rem;">
              Advanced excludable…
            </button>
          </div>

          <!-- Hidden container just to hold the advanced inputs for this case -->
          <div class="field" id="advancedMainContainer" style="display:none;">
            <input id="definitelyExcludedDays" type="number" min="0" value="0">
            <input id="arguablyExcludedDays" type="number" min="0" value="0">
          </div>

          <div class="field" style="align-self:flex-end;">
            <label>
              <input type="checkbox" id="clockStopped">
              Clock is currently stopped
            </label>
            <div class="small-text">
              When checked, total days are frozen as of today.
            </div>
            <button type="submit" class="primary" style="margin-top:0.5rem;">Add / Update Case</button>
          </div>
        </div>

        <input type="hidden" id="editingId" value="">
      </form>

      <div class="field search-input">
        <label for="search">Filter Cases</label>
        <input id="search" placeholder="Search by client, docket, ADA, notes...">
      </div>
    </div>

    <div class="filters-row">
      <div class="field-inline">
        <label for="sortMode">Sort by</label>
        <select id="sortMode">
          <option value="client">Client (A → Z)</option>
          <option value="ncd">NCD (soonest first)</option>
        </select>
      </div>
      <div class="field-inline">
        <label for="excludeMode">Excluded time mode</label>
        <select id="excludeMode">
          <option value="defOnly">Definitely excludable only</option>
          <option value="defPlusArg">Definitely + arguably excludable</option>
        </select>
      </div>
      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="showWarrant">
          Show warrant cases
        </label>
        <label>
          <input type="checkbox" id="showClosed">
          Show closed cases
        </label>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Client</th>
          <th>Docket</th>
          <th>Charge</th>
          <th>Start</th>
          <th>Total Days</th>
          <th>Excluded</th>
          <th>Chargeable</th>
          <th>Cap (days)</th>
          <th>Deadline</th>
          <th>NCD</th>
          <th>Part</th>
        </tr>
      </thead>
      <tbody id="casesBody">
      </tbody>
    </table>
  </div>

  <!-- Case details modal -->
  <div id="caseModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Case Details</h2>
        <button class="modal-close" onclick="closeCaseModal()">×</button>
      </div>

      <div class="form-row">
        <div class="field">
          <label for="modalClientName">Client / Case Name</label>
          <input id="modalClientName">
        </div>
        <div class="field">
          <label for="modalDocketNumber">Docket / Indictment #</label>
          <input id="modalDocketNumber">
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label for="modalChargeLevel">Top Charge Level</label>
          <select id="modalChargeLevel">
            <option value="">Select...</option>
            <option value="felony">Felony</option>
            <option value="classA">Class A Misd</option>
            <option value="classB">Class B Misd</option>
            <option value="violation">Violation</option>
          </select>
        </div>
        <div class="field">
          <label for="modalStartDate">Clock Start Date</label>
          <input id="modalStartDate" type="date">
        </div>
        <div class="field">
          <label for="modalExcludedDays">Excluded Days (simple)</label>
          <input id="modalExcludedDays" type="number" min="0">
        </div>
      </div>

      <div class="form-row">
        <button type="button" class="secondary small-link" id="advancedModalToggle">
          Advanced excludable…
        </button>
      </div>

      <div class="form-row" id="advancedModalContainer" style="display:none;">
        <div class="field">
          <label for="modalDefExcluded">Definitely excludable days</label>
          <input id="modalDefExcluded" type="number" min="0">
        </div>
        <div class="field">
          <label for="modalArgExcluded">Arguably excludable days</label>
          <input id="modalArgExcluded" type="number" min="0">
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label for="modalNcd">Next Court Date (NCD)</label>
          <input id="modalNcd" type="date">
        </div>
        <div class="field">
          <label for="modalPart">Part</label>
          <input id="modalPart" placeholder="e.g., AP3, Part 41">
        </div>
        <div class="field">
          <label for="modalAda">Assigned ADA</label>
          <input id="modalAda" placeholder="ADA Name">
        </div>
      </div>

      <div class="checkbox-inline">
        <label>
          <input type="checkbox" id="modalClockStopped">
          Clock currently stopped
        </label>
        <label>
          <input type="checkbox" id="modalWarrant">
          Warrant
        </label>
        <label>
          <input type="checkbox" id="modalClosed">
          Closed
        </label>
      </div>

      <div>
        <div class="modal-section-title">Notes</div>
        <ul id="modalNotesList" class="notes-list"></ul>
        <div class="form-row">
          <div class="field">
            <label for="modalNoteDate">Note Date</label>
            <input id="modalNoteDate" type="date">
          </div>
          <div class="field">
            <label for="modalNoteText">Note Text</label>
            <textarea id="modalNoteText" rows="2" placeholder="e.g., People served discovery; defense asked for adjournment..."></textarea>
          </div>
        </div>
        <button class="secondary" onclick="addNoteToCurrentCase()">Add Note</button>
      </div>

      <div style="margin-top: 1rem; display:flex; justify-content: space-between; gap:0.5rem;">
        <button class="primary" onclick="saveModalChanges()">Save changes</button>
        <button class="danger" onclick="deleteCurrentCase()">Delete case</button>
      </div>
    </div>
  </div>

  <!-- Advanced excludable modal + calculator -->
  <div id="advExModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>Advanced excludable time</h2>
        <button class="modal-close" onclick="closeAdvExModal()">×</button>
      </div>

      <div class="form-row">
        <div class="field">
          <label for="advDefDays">Definitely excludable days</label>
          <input id="advDefDays" type="number" min="0" value="0">
        </div>
        <div class="field">
          <label for="advArgDays">Arguably excludable days</label>
          <input id="advArgDays" type="number" min="0" value="0">
        </div>
      </div>

      <div class="modal-section-title">Excludable calculator</div>
      <p class="small-text">
        Add one or more windows of excludable time. Days are counted as calendar days (inclusive of start and end).
      </p>

      <div id="exCalcRows"></div>

      <button type="button" class="secondary small-link" id="exCalcAddBtn" style="margin-top:0.3rem;">
        + Add window
      </button>

      <div class="small-text" style="margin-top:0.5rem;">
        Total excludable days from calculator: <span id="exCalcTotal">0</span>
      </div>

      <div style="margin-top: 1rem; display:flex; justify-content: flex-end; gap:0.5rem;">
        <button class="secondary" type="button" onclick="applyExCalcToDef()">Use total as definitely excludable</button>
        <button class="primary" type="button" onclick="saveAdvExAndClose()">Done</button>
      </div>
    </div>
  </div>

  <!-- CryptoJS for AES encryption of backups -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

  <!-- Supabase JS library + client init -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://pzktoyskgxwbvsauusjg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6a3RveXNrZ3h3YnZzYXV1c2pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MDEyNTEsImV4cCI6MjA3ODE3NzI1MX0.paUrNO010jaGoVIzl9ejIAIQr64MsIsVLTXfEQSuzew";

    let supabaseClient = null;
    try {
      if (window.supabase && window.supabase.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      } else {
        console.error("Supabase JS SDK not available; cloud sync disabled.");
      }
    } catch (e) {
      console.error("Error initializing Supabase; cloud sync disabled.", e);
      supabaseClient = null;
    }
  </script>

  <script>
    let currentModalCaseId = null;
    let exCalcRowCounter = 0;

    // --- Date helpers ---

    function parseLocalDate(yyyyMmDd) {
      const [y, m, d] = yyyyMmDd.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function daysBetween(startDateStr) {
      if (!startDateStr) return 0;
      const start = parseLocalDate(startDateStr);
      const today = new Date();
      start.setHours(0,0,0,0);
      today.setHours(0,0,0,0);
      const diffMs = today - start;
      return Math.max(0, Math.floor(diffMs / (1000 * 60 * 60 * 24)));
    }

    function daysBetweenDates(start, end) {
      const a = new Date(start.getTime());
      const b = new Date(end.getTime());
      a.setHours(0,0,0,0);
      b.setHours(0,0,0,0);
      const diffMs = b - a;
      return Math.max(0, Math.round(diffMs / (1000 * 60 * 60 * 24)));
    }

    function addMonthsSameDay(date, n) {
      const d = new Date(date.getTime());
      const day = d.getDate();
      d.setMonth(d.getMonth() + n);
      if (d.getDate() !== day) {
        d.setDate(0);
      }
      return d;
    }

    function addDays(date, n) {
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + n);
      return d;
    }

    // --- Holiday helpers (approx NY/US court holidays) ---

    function isSameDay(d1, d2) {
      return (
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate()
      );
    }

    function nthWeekdayOfMonth(year, month, weekday, n) {
      let d = new Date(year, month, 1);
      const diff = (weekday - d.getDay() + 7) % 7;
      d.setDate(1 + diff + 7 * (n - 1));
      return d;
    }

    function lastWeekdayOfMonth(year, month, weekday) {
      let d = new Date(year, month + 1, 0); // last day of month
      const diff = (d.getDay() - weekday + 7) % 7;
      d.setDate(d.getDate() - diff);
      return d;
    }

    function getHolidayName(date) {
      const y = date.getFullYear();

      function isDate(dt) {
        return isSameDay(date, dt);
      }

      // New Year's Day (Jan 1, observed Monday if Sunday)
      const newYears = new Date(y, 0, 1);
      const newYearsObserved = (newYears.getDay() === 0)
        ? new Date(y, 0, 2)
        : newYears;
      if (isDate(newYearsObserved)) return "New Year's Day";

      // Martin Luther King Jr. Day – third Monday in January
      const mlk = nthWeekdayOfMonth(y, 0, 1, 3);
      if (isDate(mlk)) return "Martin Luther King Jr. Day";

      // Presidents' Day – third Monday in February
      const presidents = nthWeekdayOfMonth(y, 1, 1, 3);
      if (isDate(presidents)) return "Presidents' Day";

      // Memorial Day – last Monday in May
      const memorial = lastWeekdayOfMonth(y, 4, 1);
      if (isDate(memorial)) return "Memorial Day";

      // Juneteenth – June 19 (observed Monday if Sunday)
      const juneteenth = new Date(y, 5, 19);
      const juneteenthObserved =
        juneteenth.getDay() === 0 ? new Date(y, 5, 20) : juneteenth;
      if (isDate(juneteenthObserved)) return "Juneteenth";

      // Independence Day – July 4 (observed Monday if Sunday)
      const july4 = new Date(y, 6, 4);
      const july4Observed =
        july4.getDay() === 0 ? new Date(y, 6, 5) : july4;
      if (isDate(july4Observed)) return "Independence Day";

      // Labor Day – first Monday in September
      const labor = nthWeekdayOfMonth(y, 8, 1, 1);
      if (isDate(labor)) return "Labor Day";

      // Columbus Day – second Monday in October
      const columbus = nthWeekdayOfMonth(y, 9, 1, 2);
      if (isDate(columbus)) return "Columbus Day";

      // Veterans Day – Nov 11 (observed Monday if Sunday)
      const veterans = new Date(y, 10, 11);
      const veteransObserved =
        veterans.getDay() === 0 ? new Date(y, 10, 12) : veterans;
      if (isDate(veteransObserved)) return "Veterans Day";

      // Thanksgiving – fourth Thursday in November
      const thanksgiving = nthWeekdayOfMonth(y, 10, 4, 4);
      if (isDate(thanksgiving)) return "Thanksgiving Day";

      // Christmas Day – Dec 25 (observed Monday if Sunday)
      const christmas = new Date(y, 11, 25);
      const christmasObserved =
        christmas.getDay() === 0 ? new Date(y, 11, 26) : christmas;
      if (isDate(christmasObserved)) return "Christmas Day";

      return "";
    }

    function adjustForWeekendOrHoliday(baseDate) {
      const d = new Date(baseDate.getTime());
      let tooltip = "";

      // Weekend first
      if (d.getDay() === 6) {
        d.setDate(d.getDate() + 2);
        tooltip = "Adjusted for deadline falling on Saturday";
      } else if (d.getDay() === 0) {
        d.setDate(d.getDate() + 1);
        tooltip = "Adjusted for deadline falling on Sunday";
      } else {
        // Weekday: shift off holidays until we land on a non-holiday weekday
        while (true) {
          const name = getHolidayName(d);
          if (!name) break;
          d.setDate(d.getDate() + 1);
          tooltip = `Adjusted for ${name}`;
        }
      }

      return { adjustedDate: d, tooltip };
    }

    function computeCapAndDeadline(level, startDateStr) {
      if (!startDateStr) return { capDays: 0, deadlineStr: '', tooltip: '' };

      const start = parseLocalDate(startDateStr);
      let baseDeadline, capDays;

      if (level === 'felony') {
        baseDeadline = addMonthsSameDay(start, 6);
        capDays = daysBetweenDates(start, baseDeadline);
      } else if (level === 'classA') {
        baseDeadline = addDays(start, 90);
        capDays = 90;
      } else if (level === 'classB') {
        baseDeadline = addDays(start, 60);
        capDays = 60;
      } else if (level === 'violation') {
        baseDeadline = addDays(start, 30);
        capDays = 30;
      } else {
        return { capDays: 0, deadlineStr: '', tooltip: '' };
      }

      const { adjustedDate, tooltip } = adjustForWeekendOrHoliday(baseDeadline);
      const deadlineStr = formatDate(adjustedDate);

      return { capDays, deadlineStr, tooltip };
    }

    function ncdClass(nextCourtDateStr) {
      if (!nextCourtDateStr) return '';
      const today = new Date();
      today.setHours(0,0,0,0);
      const ncd = parseLocalDate(nextCourtDateStr);
      ncd.setHours(0,0,0,0);
      const diffMs = ncd - today;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      if (diffDays < 0) return 'ncd-red';
      if (diffDays <= 7) return 'ncd-yellow';
      return 'ncd-green';
    }

    // --- Local storage helpers ---

    function loadCases() {
      const raw = localStorage.getItem('ny3030Cases');
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return arr.map(c => ({
          id: c.id,
          clientName: c.clientName || '',
          docketNumber: c.docketNumber || '',
          chargeLevel: c.chargeLevel || '',
          startDate: c.startDate || '',
          excludedDays: c.excludedDays || "0",
          definitelyExcludedDays: c.definitelyExcludedDays || "0",
          arguablyExcludedDays: c.arguablyExcludedDays || "0",
          notes: c.notes || '',
          nextCourtDate: c.nextCourtDate || '',
          courtPart: c.courtPart || '',
          assignedAda: c.assignedAda || '',
          noteEntries: Array.isArray(c.noteEntries) ? c.noteEntries : [],
          warrant: !!c.warrant,
          closed: !!c.closed,
          clockStopped: !!c.clockStopped,
          frozenTotalDays: typeof c.frozenTotalDays === 'number' ? c.frozenTotalDays : null
        }));
      } catch {
        return [];
      }
    }

    function saveCases(cases) {
      localStorage.setItem('ny3030Cases', JSON.stringify(cases));
    }

    // --- UI helpers ---

    function chargeTag(level) {
      switch (level) {
        case 'felony': return '<span class="tag tag-felony">Felony</span>';
        case 'classA': return '<span class="tag tag-a">Class A Misd</span>';
        case 'classB': return '<span class="tag tag-b">Class B Misd</span>';
        case 'violation': return '<span class="tag tag-v">Violation</span>';
        default: return '';
      }
    }

    function compareByClient(a, b) {
      return (a.clientName || '').localeCompare(b.clientName || '', undefined, { sensitivity: 'base' });
    }

    function compareByNcd(a, b) {
      const today = new Date();
      today.setHours(0,0,0,0);

      function score(c) {
        if (!c.nextCourtDate) return Number.POSITIVE_INFINITY;
        const d = parseLocalDate(c.nextCourtDate);
        d.setHours(0,0,0,0);
        const diffDays = Math.floor((d - today) / (1000 * 60 * 60 * 24));
        return diffDays;
      }

      const sa = score(a);
      const sb = score(b);
      return sa - sb;
    }

    // --- Rendering main table ---

    function renderCases() {
      const tbody = document.getElementById('casesBody');
      let cases = loadCases();
      const filter = document.getElementById('search').value.toLowerCase();
      const sortMode = document.getElementById('sortMode').value;
      const showWarrant = document.getElementById('showWarrant').checked;
      const showClosed = document.getElementById('showClosed').checked;
      const excludeMode = document.getElementById('excludeMode').value;

      cases = cases.filter(c => {
        if (c.closed && !showClosed) return false;
        if (c.warrant && !showWarrant) return false;
        return true;
      });

      if (filter) {
        cases = cases.filter(c => {
          const combinedText = (
            c.clientName + ' ' +
            c.docketNumber + ' ' +
            (c.notes || '') + ' ' +
            (c.assignedAda || '')
          ).toLowerCase();
          return combinedText.includes(filter);
        });
      }

      if (sortMode === 'ncd') {
        cases.sort(compareByNcd);
      } else {
        cases.sort(compareByClient);
      }

      tbody.innerHTML = '';

      cases.forEach(c => {
        const baseTotal = daysBetween(c.startDate);
        const totalDays = c.clockStopped && c.frozenTotalDays != null ? c.frozenTotalDays : baseTotal;

        const simpleExcluded = Number(c.excludedDays) || 0;
        const defEx = Number(c.definitelyExcludedDays) || 0;
        const argEx = Number(c.arguablyExcludedDays) || 0;

        let excluded = simpleExcluded;
        let excludedDetail = `${simpleExcluded} (simple total)`;

        if (defEx || argEx) {
          if (excludeMode === 'defOnly') {
            excluded = defEx;
            excludedDetail = `${defEx} definitely excludable; ${argEx} arguably excludable (not counted)`;
          } else {
            excluded = defEx + argEx;
            excludedDetail = `${defEx} definitely + ${argEx} arguably excludable (both counted)`;
          }
        }

        const chargeable = Math.max(0, totalDays - excluded);

        const { capDays, deadlineStr, tooltip } = computeCapAndDeadline(c.chargeLevel, c.startDate);
        const ncdCls = ncdClass(c.nextCourtDate);

        const tr = document.createElement('tr');
        if (c.warrant) tr.classList.add('row-warrant');
        if (c.closed) tr.classList.add('row-closed');

        let clientCell = c.clientName;
        if (c.warrant) clientCell += ' <span class="badge badge-warrant">Warrant</span>';
        if (c.closed) clientCell += ' <span class="badge badge-closed">Closed</span>';
        if (c.clockStopped) clientCell += ' <span class="badge" style="background:#e0f2fe;color:#1d4ed8;">Clock stopped</span>';

        tr.innerHTML = `
          <td>${clientCell}</td>
          <td>${c.docketNumber || ''}</td>
          <td>${chargeTag(c.chargeLevel)}</td>
          <td>${c.startDate || ''}</td>
          <td>${totalDays}</td>
          <td title="${excludedDetail}">${excluded}</td>
          <td>${chargeable}</td>
          <td>${capDays || ''}</td>
          <td title="${tooltip || ''}">${deadlineStr || ''}</td>
          <td class="${ncdCls}">${c.nextCourtDate || ''}</td>
          <td>${c.courtPart || ''}</td>
        `;

        tr.addEventListener('click', () => {
          openCaseModal(c.id);
        });

        tbody.appendChild(tr);
      });
    }

    // --- Modal logic (case details) ---

    function openCaseModal(id) {
      const cases = loadCases();
      const c = cases.find(c => c.id === id);
      if (!c) return;
      currentModalCaseId = id;

      document.getElementById('modalTitle').textContent = c.clientName || 'Case Details';
      document.getElementById('modalClientName').value = c.clientName || '';
      document.getElementById('modalDocketNumber').value = c.docketNumber || '';
      document.getElementById('modalChargeLevel').value = c.chargeLevel || '';
      document.getElementById('modalStartDate').value = c.startDate || '';
      document.getElementById('modalExcludedDays').value = c.excludedDays || "0";
      document.getElementById('modalDefExcluded').value = c.definitelyExcludedDays || "0";
      document.getElementById('modalArgExcluded').value = c.arguablyExcludedDays || "0";
      document.getElementById('modalNcd').value = c.nextCourtDate || '';
      document.getElementById('modalPart').value = c.courtPart || '';
      document.getElementById('modalAda').value = c.assignedAda || '';
      document.getElementById('modalClockStopped').checked = !!c.clockStopped;
      document.getElementById('modalWarrant').checked = !!c.warrant;
      document.getElementById('modalClosed').checked = !!c.closed;

      document.getElementById('modalNoteDate').value = '';
      document.getElementById('modalNoteText').value = '';

      renderModalNotes(c.noteEntries || []);

      const advModal = document.getElementById('advancedModalContainer');
      if ((Number(c.definitelyExcludedDays) || 0) > 0 || (Number(c.arguablyExcludedDays) || 0) > 0) {
        advModal.style.display = 'flex';
      } else {
        advModal.style.display = 'none';
      }

      document.getElementById('caseModal').style.display = 'flex';
    }

    function closeCaseModal() {
      currentModalCaseId = null;
      document.getElementById('caseModal').style.display = 'none';
    }

    function renderModalNotes(notes) {
      const list = document.getElementById('modalNotesList');
      list.innerHTML = '';
      if (!notes || notes.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No notes yet.';
        list.appendChild(li);
        return;
      }
      notes.forEach(n => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="note-date">${n.date || ''}</span>: ${n.text || ''}`;
        list.appendChild(li);
      });
    }

    function addNoteToCurrentCase() {
      if (!currentModalCaseId) return;
      const date = document.getElementById('modalNoteDate').value;
      const text = document.getElementById('modalNoteText').value.trim();
      if (!date && !text) {
        alert('Enter a date and/or note text.');
        return;
      }

      const cases = loadCases();
      const idx = cases.findIndex(c => c.id === currentModalCaseId);
      if (idx === -1) return;

      const caseObj = cases[idx];
      if (!Array.isArray(caseObj.noteEntries)) {
        caseObj.noteEntries = [];
      }
      caseObj.noteEntries.push({ date, text });
      saveCases(cases);

      document.getElementById('modalNoteDate').value = '';
      document.getElementById('modalNoteText').value = '';
      renderModalNotes(caseObj.noteEntries);
    }

    function saveModalChanges() {
      if (!currentModalCaseId) return;
      const cases = loadCases();
      const idx = cases.findIndex(c => c.id === currentModalCaseId);
      if (idx === -1) return;

      const c = cases[idx];

      c.clientName = document.getElementById('modalClientName').value.trim();
      c.docketNumber = document.getElementById('modalDocketNumber').value.trim();
      c.chargeLevel = document.getElementById('modalChargeLevel').value;
      c.startDate = document.getElementById('modalStartDate').value;
      c.excludedDays = document.getElementById('modalExcludedDays').value || "0";
      c.definitelyExcludedDays = document.getElementById('modalDefExcluded').value || "0";
      c.arguablyExcludedDays = document.getElementById('modalArgExcluded').value || "0";
      c.nextCourtDate = document.getElementById('modalNcd').value;
      c.courtPart = document.getElementById('modalPart').value.trim();
      c.assignedAda = document.getElementById('modalAda').value.trim();

      const newClockStopped = document.getElementById('modalClockStopped').checked;
      const wasStopped = c.clockStopped;

      if (!wasStopped && newClockStopped) {
        c.frozenTotalDays = daysBetween(c.startDate);
      } else if (wasStopped && !newClockStopped) {
        c.frozenTotalDays = null;
      }

      c.clockStopped = newClockStopped;
      c.warrant = document.getElementById('modalWarrant').checked;
      c.closed = document.getElementById('modalClosed').checked;

      saveCases(cases);
      renderCases();
      closeCaseModal();
    }

    function deleteCurrentCase() {
      if (!currentModalCaseId) return;
      if (!confirm('Delete this case from your tracker?')) return;

      const cases = loadCases().filter(c => c.id !== currentModalCaseId);
      saveCases(cases);
      renderCases();
      closeCaseModal();
    }

    // --- Advanced excludable modal + calculator (main form) ---

    function openAdvExModal() {
      const defHidden = document.getElementById('definitelyExcludedDays');
      const argHidden = document.getElementById('arguablyExcludedDays');
      document.getElementById('advDefDays').value = defHidden.value || "0";
      document.getElementById('advArgDays').value = argHidden.value || "0";

      resetExCalc();
      document.getElementById('advExModal').style.display = 'flex';
    }

    function closeAdvExModal() {
      document.getElementById('advExModal').style.display = 'none';
    }

    function saveAdvExAndClose() {
      const defHidden = document.getElementById('definitelyExcludedDays');
      const argHidden = document.getElementById('arguablyExcludedDays');
      defHidden.value = document.getElementById('advDefDays').value || "0";
      argHidden.value = document.getElementById('advArgDays').value || "0";
      closeAdvExModal();
    }

    function applyExCalcToDef() {
      const total = Number(document.getElementById('exCalcTotal').textContent) || 0;
      document.getElementById('advDefDays').value = String(total);
    }

    function resetExCalc() {
      const container = document.getElementById('exCalcRows');
      container.innerHTML = '';
      exCalcRowCounter = 0;
      addExCalcRow();
      recalcExCalcTotals();
    }

    function addExCalcRow() {
      const container = document.getElementById('exCalcRows');
      const rowId = ++exCalcRowCounter;
      const row = document.createElement('div');
      row.className = 'excalc-row';
      row.dataset.rowId = rowId;

      row.innerHTML = `
        <input type="date" class="excalc-start">
        <input type="date" class="excalc-end">
        <span class="excalc-days">0 days</span>
        <button type="button" class="secondary small-link excalc-remove" title="Remove window">×</button>
      `;

      const startInput = row.querySelector('.excalc-start');
      const endInput = row.querySelector('.excalc-end');
      const removeBtn = row.querySelector('.excalc-remove');

      startInput.addEventListener('change', recalcExCalcTotals);
      endInput.addEventListener('change', recalcExCalcTotals);
      removeBtn.addEventListener('click', () => {
        row.remove();
        recalcExCalcTotals();
      });

      container.appendChild(row);
    }

    function recalcExCalcTotals() {
      const rows = Array.from(document.querySelectorAll('.excalc-row'));
      let total = 0;

      rows.forEach(row => {
        const startVal = row.querySelector('.excalc-start').value;
        const endVal = row.querySelector('.excalc-end').value;
        let days = 0;
        if (startVal && endVal) {
          const s = parseLocalDate(startVal);
          const e = parseLocalDate(endVal);
          if (e >= s) {
            days = daysBetweenDates(s, e) + 1; // inclusive
          }
        }
        row.querySelector('.excalc-days').textContent = `${days} day${days === 1 ? '' : 's'}`;
        total += days;
      });

      document.getElementById('exCalcTotal').textContent = String(total);
    }

    // --- Local encrypted backup ---

    function setBackupStatus(msg) {
      document.getElementById('backupStatus').innerText = msg || '';
    }

    function getBackupPassword() {
      const pw = document.getElementById('backupPassword').value;
      if (!pw) {
        alert('Enter a backup password first.');
        return null;
      }
      return pw;
    }

    function exportEncryptedBackup() {
      const password = getBackupPassword();
      if (!password) return;

      const cases = loadCases();
      if (!cases || cases.length === 0) {
        if (!confirm('You currently have no cases stored. Export an empty backup?')) {
          return;
        }
      }

      try {
        const plaintext = JSON.stringify(cases);
        const ciphertext = CryptoJS.AES.encrypt(plaintext, password).toString();

        const blob = new Blob([ciphertext], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'nycasetracker-backup.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setBackupStatus('Encrypted backup exported. Keep the file and password safe.');
      } catch (err) {
        console.error(err);
        alert('Something went wrong creating the backup.');
      }
    }

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const password = getBackupPassword();
      if (!password) {
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const ciphertext = e.target.result;
          const bytes = CryptoJS.AES.decrypt(ciphertext, password);
          const plaintext = bytes.toString(CryptoJS.enc.Utf8);

          if (!plaintext) {
            throw new Error('Decryption resulted in empty text (wrong password or corrupt file).');
          }

          const importedCases = JSON.parse(plaintext);
          if (!Array.isArray(importedCases)) {
            throw new Error('Backup file format not recognized.');
          }

          saveCases(importedCases);
          renderCases();
          setBackupStatus('Backup imported successfully onto this device.');
          alert('Import successful. Your cases are now loaded on this computer.');
        } catch (err) {
          console.error(err);
          alert('Could not decrypt/import backup. Check your password and that you chose the correct file.');
        } finally {
          event.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    // --- Cloud auth helpers ---

    async function getCurrentUser() {
      if (!supabaseClient) return null;
      const { data, error } = await supabaseClient.auth.getUser();
      if (error) {
        console.error("Error getting current user:", error);
        return null;
      }
      return data.user || null;
    }

    async function refreshAuthStatus() {
      const loginForm = document.getElementById('cloudLoginForm');
      const signedInRow = document.getElementById('cloudSignedInRow');
      const statusEl = document.getElementById('cloudUserStatus');

      const user = await getCurrentUser();

      if (user) {
        if (loginForm) loginForm.style.display = 'block';
        if (loginForm) loginForm.style.visibility = 'hidden';
        if (signedInRow) signedInRow.style.display = 'flex';
        if (statusEl) statusEl.textContent = `Signed in as ${user.email}`;
      } else {
        if (loginForm) {
          loginForm.style.display = 'block';
          loginForm.style.visibility = 'visible';
        }
        if (signedInRow) signedInRow.style.display = 'none';
        if (statusEl) statusEl.textContent = '';
      }
    }

    function setCloudStatus(msg) {
      document.getElementById('cloudStatus').innerText = msg || '';
    }

    // --- Supabase sync (secure, per-user; no client/docket in cloud) ---

    async function saveCasesToSupabase() {
      if (!supabaseClient) {
        alert('Cloud sync is currently unavailable (Supabase SDK not loaded).');
        return;
      }

      const user = await getCurrentUser();
      if (!user) {
        alert('Sign in to cloud first (email + password) before saving.');
        return;
      }

      const cases = loadCases();
      if (!confirm(
        `This will overwrite all rows in cloud storage for ${user.email}. Continue?`
      )) {
        return;
      }

      try {
        setCloudStatus('Saving to cloud...');

        const { error: delError } = await supabaseClient
          .from('cases')
          .delete()
          .eq('user_id', user.id);

        if (delError) {
          console.error(delError);
          setCloudStatus('Error clearing existing rows in cloud for this user.');
          alert('Error clearing cloud rows for this user. See console.');
          return;
        }

        const payload = cases.map(c => ({
          user_id: user.id,
          client_name: null,
          docket_number: null,
          charge_level: c.chargeLevel,
          start_date: c.startDate || null,
          excluded_days: Number(c.excludedDays) || 0,
          notes: c.notes || null,
          next_court_date: c.nextCourtDate || null,
          court_part: c.courtPart || null,
          assigned_ada: c.assignedAda || null,
          note_entries: c.noteEntries || [],
          warrant: !!c.warrant,
          closed: !!c.closed,
          clock_stopped: !!c.clockStopped,
          frozen_total_days: c.frozenTotalDays != null ? c.frozenTotalDays : null,
          definitely_excluded_days: Number(c.definitelyExcludedDays) || 0,
          arguably_excluded_days: Number(c.arguablyExcludedDays) || 0
        }));

        if (payload.length === 0) {
          setCloudStatus(`No local cases to save; cloud rows for ${user.email} are now cleared.`);
          alert(`Cloud cleared; no local cases to upload for ${user.email}.`);
          return;
        }

        const { error: insError } = await supabaseClient
          .from('cases')
          .insert(payload);

        if (insError) {
          console.error(insError);
          setCloudStatus('Error saving cases to cloud.');
          alert('Error saving cases to cloud. See console.');
          return;
        }

        setCloudStatus(`Saved current cases to cloud for ${user.email}.`);
        alert('Saved current cases to cloud.');
      } catch (err) {
        console.error(err);
        setCloudStatus('Unexpected error talking to cloud.');
        alert('Unexpected error talking to cloud.');
      }
    }

    async function loadCasesFromSupabase(silent = false) {
      if (!supabaseClient) {
        if (!silent) alert('Cloud sync is currently unavailable (Supabase SDK not loaded).');
        return;
      }

      const user = await getCurrentUser();
      if (!user) {
        if (!silent) alert('Sign in to cloud first (email + password) before loading.');
        return;
      }

      try {
        setCloudStatus('Loading from cloud...');

        const { data, error } = await supabaseClient
          .from('cases')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: true });

        if (error) {
          console.error(error);
          setCloudStatus('Error loading from cloud.');
          if (!silent) alert('Error loading from cloud. See console.');
          return;
        }

        const rows = data || [];
        if (rows.length === 0) {
          setCloudStatus(`No rows found in cloud for ${user.email}.`);
          if (!silent) alert('Cloud has no cases stored yet for this account.');
          return;
        }

        const mapped = rows.map(row => ({
          id: row.id || ('supabase-' + (row.docket_number || '') + '-' + Math.random().toString(36).slice(2)),
          clientName: '',          // redacted in cloud
          docketNumber: '',        // redacted in cloud
          chargeLevel: row.charge_level || '',
          startDate: row.start_date || '',
          excludedDays: String(row.excluded_days ?? 0),
          notes: row.notes || '',
          nextCourtDate: row.next_court_date || '',
          courtPart: row.court_part || '',
          assignedAda: row.assigned_ada || '',
          noteEntries: Array.isArray(row.note_entries) ? row.note_entries : [],
          warrant: !!row.warrant,
          closed: !!row.closed,
          clockStopped: !!row.clock_stopped,
          frozenTotalDays: typeof row.frozen_total_days === 'number' ? row.frozen_total_days : null,
          definitelyExcludedDays: String(row.definitely_excluded_days ?? 0),
          arguablyExcludedDays: String(row.arguably_excluded_days ?? 0)
        }));

        saveCases(mapped);
        renderCases();
        setCloudStatus(`Loaded cases from cloud for ${user.email}.`);
        if (!silent) alert('Loaded cases from cloud into this browser.');
      } catch (err) {
        console.error(err);
        setCloudStatus('Unexpected error talking to cloud.');
        if (!silent) alert('Unexpected error talking to cloud.');
      }
    }

    // --- Cloud auth button handlers ---

    async function handleCloudSignUp() {
      if (!supabaseClient) {
        alert('Cloud sync is currently unavailable (Supabase SDK not loaded). Local storage still works.');
        return;
      }
      const email = document.getElementById('cloudEmail').value.trim();
      const password = document.getElementById('cloudPassword').value;
      if (!email || !password) {
        alert('Enter email and password first.');
        return;
      }

      const { error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        console.error(error);
        alert('Sign up error: ' + error.message);
        return;
      }

      alert('Sign up successful. If email confirmations are enabled, check your inbox.');
      await refreshAuthStatus();
    }

    async function handleCloudSignIn() {
      if (!supabaseClient) {
        alert('Cloud sync is currently unavailable (Supabase SDK not loaded). Local storage still works.');
        return;
      }

      const email = document.getElementById('cloudEmail').value.trim();
      const password = document.getElementById('cloudPassword').value;
      if (!email || !password) {
        alert('Enter email and password first.');
        return;
      }

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        alert('Sign in error: ' + error.message);
        return;
      }

      document.getElementById('cloudPassword').value = '';
      await refreshAuthStatus();
      await loadCasesFromSupabase(false);
    }

    async function handleCloudSignOut() {
      if (!supabaseClient) {
        alert('Cloud sync is currently unavailable (Supabase SDK not loaded).');
        return;
      }

      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        console.error(error);
        alert('Sign out error: ' + error.message);
        return;
      }
      document.getElementById('cloudPassword').value = '';
      await refreshAuthStatus();
    }

    // --- Form / events ---

    document.getElementById('case-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const clientName = document.getElementById('clientName').value.trim();
      const docketNumber = document.getElementById('docketNumber').value.trim();
      const chargeLevel = document.getElementById('chargeLevel').value;
      const startDate = document.getElementById('startDate').value;
      const ncd = document.getElementById('ncd').value;
      const part = document.getElementById('part').value.trim();
      const excludedDays = document.getElementById('excludedDays').value || "0";
      const definitelyExcludedDays = document.getElementById('definitelyExcludedDays').value || "0";
      const arguablyExcludedDays = document.getElementById('arguablyExcludedDays').value || "0";
      const clockStopped = document.getElementById('clockStopped').checked;
      const editingId = document.getElementById('editingId').value;

      if (!clientName || !chargeLevel || !startDate) {
        alert('Client name, charge level, and start date are required.');
        return;
      }

      const cases = loadCases();

      if (editingId) {
        const idx = cases.findIndex(c => c.id === editingId);
        if (idx !== -1) {
          const existing = cases[idx];
          const updated = {
            ...existing,
            clientName,
            docketNumber,
            chargeLevel,
            startDate,
            excludedDays,
            definitelyExcludedDays,
            arguablyExcludedDays,
            nextCourtDate: ncd,
            courtPart: part
          };

          if (clockStopped && !existing.clockStopped) {
            updated.clockStopped = true;
            updated.frozenTotalDays = daysBetween(startDate);
          } else if (!clockStopped && existing.clockStopped) {
            updated.clockStopped = false;
            updated.frozenTotalDays = null;
          } else {
            updated.clockStopped = existing.clockStopped;
            updated.frozenTotalDays = existing.frozenTotalDays ?? null;
          }

          cases[idx] = updated;
        }
      } else {
        const newCase = {
          id: 'case-' + Date.now() + '-' + Math.random().toString(36).slice(2),
          clientName,
          docketNumber,
          chargeLevel,
          startDate,
          excludedDays,
          definitelyExcludedDays,
          arguablyExcludedDays,
          notes: '',
          nextCourtDate: ncd,
          courtPart: part,
          assignedAda: '',
          noteEntries: [],
          warrant: false,
          closed: false,
          clockStopped,
          frozenTotalDays: clockStopped ? daysBetween(startDate) : null
        };
        cases.push(newCase);
      }

      saveCases(cases);

      document.getElementById('editingId').value = '';
      document.getElementById('case-form').reset();
      document.getElementById('excludedDays').value = "0";
      document.getElementById('definitelyExcludedDays').value = "0";
      document.getElementById('arguablyExcludedDays').value = "0";

      renderCases();
    });

    document.getElementById('search').addEventListener('input', renderCases);
    document.getElementById('sortMode').addEventListener('change', renderCases);
    document.getElementById('excludeMode').addEventListener('change', renderCases);
    document.getElementById('showWarrant').addEventListener('change', renderCases);
    document.getElementById('showClosed').addEventListener('change', renderCases);

    document.getElementById('exportBtn').addEventListener('click', exportEncryptedBackup);
    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });
    document.getElementById('importFile').addEventListener('change', handleImportFile);

    document.getElementById('cloudSaveBtn').addEventListener('click', saveCasesToSupabase);
    document.getElementById('cloudSignUp').addEventListener('click', handleCloudSignUp);
    document.getElementById('cloudSignIn').addEventListener('click', handleCloudSignIn);
    document.getElementById('cloudSignOut').addEventListener('click', handleCloudSignOut);

    document.getElementById('advancedMainToggle').addEventListener('click', openAdvExModal);
    document.getElementById('advancedModalToggle').addEventListener('click', () => {
      const box = document.getElementById('advancedModalContainer');
      box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'flex' : 'none';
    });

    document.getElementById('exCalcAddBtn').addEventListener('click', () => {
      addExCalcRow();
      recalcExCalcTotals();
    });

    document.getElementById('caseModal').addEventListener('click', (e) => {
      if (e.target.id === 'caseModal') {
        closeCaseModal();
      }
    });

    document.getElementById('advExModal').addEventListener('click', (e) => {
      if (e.target.id === 'advExModal') {
        closeAdvExModal();
      }
    });

    async function initAuthAndMaybeLoad() {
      await refreshAuthStatus();
      const user = await getCurrentUser();
      if (user) {
        await loadCasesFromSupabase(true);
      }
    }

    renderCases();
    initAuthAndMaybeLoad();
  </script>
</body>
</html>
